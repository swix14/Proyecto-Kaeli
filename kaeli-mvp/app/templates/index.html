<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Kaeli - Tu Mejor Precio Siempre (v1 corregido)</title>
<style>
:root{
  --kaeli-blue:#007aff;--kaeli-blue-dark:#005ecb;--kaeli-green:#00a859;
  --kaeli-red:#e4002b;--kaeli-light-bg:#f9f9f9;--kaeli-border:#e0e0e0;
  --kaeli-text-dark:#333;--kaeli-text-light:#ffffff;--kaeli-white:#fff;
}
*{box-sizing:border-box}
html{scroll-behavior:smooth}
body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;margin:0;background:var(--kaeli-light-bg);color:var(--kaeli-text-dark)}
.container{max-width:1000px;margin:0 auto;padding:20px}
.hidden{display:none !important}
header{background:var(--kaeli-white);border-bottom:1px solid var(--kaeli-border);padding:15px 30px;display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;z-index:100}
.logo{font-size:1.8em;font-weight:700;color:var(--kaeli-blue);cursor:pointer}
nav{display:flex;gap:20px}
.nav-link{font-weight:500;color:var(--kaeli-text-light);cursor:pointer;padding:10px;border-radius:5px;transition:.15s}
.nav-link.active{color:var(--kaeli-blue);background:var(--kaeli-light-bg)}
.btn{padding:10px 15px;border-radius:5px;border:0;cursor:pointer;font-weight:700}
.btn-primary{background:var(--kaeli-blue);color:white}
.btn-primary:hover{background:var(--kaeli-blue-dark)}
.btn-secondary{background:var(--kaeli-light-bg);color:var(--kaeli-blue);border:1px solid var(--kaeli-border)}
.btn-logout{background:#6c757d;color:white}
.auth-buttons{display:flex;gap:10px;align-items:center}
#user-welcome{font-weight:500;color:var(--kaeli-text-light);margin-right:10px}

/* views */
.view{padding-top:20px}
.auth-container{max-width:400px;margin:40px auto;background:var(--kaeli-white);padding:30px;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,.05)}
.form-group{margin-bottom:15px}
.form-group label{display:block;margin-bottom:5px;font-weight:500}
.form-group input, .form-group textarea{width:100%;padding:12px;border:1px solid var(--kaeli-border);border-radius:5px;font-size:1em}
.form-button{width:100%;font-size:1.1em}
.section-title{font-size:1.6em;font-weight:600;color:var(--kaeli-text-dark);border-bottom:2px solid var(--kaeli-blue);padding-bottom:10px;margin:20px 0}

/* home */
.search-container{text-align:center;margin:20px 0}
.search-container input{width:70%;padding:15px;font-size:1.05em;border:1px solid var(--kaeli-border);border-radius:8px}
#results-grid {display: grid;grid-template-columns: repeat(3, 1fr); /* 3 columnas iguales */gap: 20px; /* espacio entre tarjetas */margin-top: 20px;}
.product-card{background:var(--kaeli-white);border:1px solid var(--kaeli-border);border-radius:8px;box-shadow:0 2px 5px rgba(0,0,0,.03);overflow:hidden;transition:.15s}
.product-card-body{padding:20px;cursor:pointer}
.product-card-store{font-size:1.1em;font-weight:700;padding:12px;border-bottom:1px solid var(--kaeli-border)}
.product-card-price{font-size:1.4em;font-weight:700;margin-top:10px}
.detail-layout{display:grid;grid-template-columns:1fr 1fr;gap:30px;background:var(--kaeli-white);padding:30px;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,.05)}
#detail-image{width:100%;height:500px;background:var(--kaeli-light-bg);border:1px solid var(--kaeli-border);border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:5em}
.price-list{list-style:none;padding:0;margin:0}
.price-list-item{display:flex;justify-content:space-between;align-items:center;padding:12px;border:1px solid var(--kaeli-border);border-radius:6px;margin-bottom:10px}
.review-list{list-style:none;padding:0;margin:0}
.review-item{background:var(--kaeli-white);padding:15px;border-radius:8px;border:1px solid var(--kaeli-border);margin-bottom:10px}
#review-form{background:var(--kaeli-white);padding:20px;border-radius:8px;border:1px solid var(--kaeli-border);margin-top:10px}
.chat-container{max-width:700px;margin:20px auto;background:var(--kaeli-white);border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,.05);border:1px solid var(--kaeli-border)}
#chat-box{height:300px;overflow-y:auto;padding:20px;border-bottom:1px solid var(--kaeli-border)}
.chat-msg{max-width:80%;padding:10px 15px;border-radius:15px;margin-bottom:10px}
.chat-msg-bot{background:var(--kaeli-light-bg);border:1px solid var(--kaeli-border)}
.chat-msg-user{background:var(--kaeli-blue);color:white;margin-left:auto;border-bottom-right-radius:3px}
.modal-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);z-index:200;display:flex;justify-content:center;align-items:center}
.modal-content{background:var(--kaeli-white);width:90%;max-width:600px;border-radius:8px;box-shadow:0 5px 20px rgba(0,0,0,.2)}
.modal-header{padding:15px 20px;border-bottom:1px solid var(--kaeli-border);display:flex;justify-content:space-between;align-items:center}
.modal-body{padding:20px}
#cart-items-list li {display: flex;justify-content: space-between; /* nombre a la izquierda, controles a la derecha */align-items: center;padding: 10px;border-bottom: 1px solid var(--kaeli-border);}.cart-controls {display: flex;align-items: center;gap: 10px; /* espacio entre üóëÔ∏è y botones */}.cart-quantity {display: flex;align-items: center;gap: 5px;}.cart-quantity button {background: var(--kaeli-blue);color: white;border: none;padding: 5px 10px;border-radius: 4px;cursor: pointer;}
#cart-total{font-size:1.2em;font-weight:700;text-align:right;margin-top:10px;color:var(--kaeli-blue)}
#error-toast{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:var(--kaeli-red);color:white;padding:12px 18px;border-radius:6px;z-index:999;opacity:0;visibility:hidden;transition:.25s}
#error-toast.show{opacity:1;visibility:visible}
.product-card {transition: transform 0.2s, box-shadow 0.2s;}.product-card:hover {transform: translateY(-4px);box-shadow: 0 4px 10px rgba(0,0,0,0.15);}
.btn {transition: background 0.2s, transform 0.1s;}.btn:hover {transform: scale(1.05);}
.review-item {background: #fafafa;border-left: 4px solid var(--kaeli-blue);}.review-item strong {color: var(--kaeli-blue);}
#cart-total {font-size: 1.4em;color: var(--kaeli-blue);margin-top: 15px;border-top: 2px solid var(--kaeli-border);padding-top: 10px;}
#cart-items-list li {background: #fff;border-radius: 6px; margin-bottom: 8px;}
header {box-shadow: 0 2px 6px rgba(0,0,0,0.1);background: var(--kaeli-blue);color: white;}header .logo { color: white; }.nav-link { color: white; }.nav-link.active { background: rgba(255,255,255,0.2); border-radius: 5px; }
input, textarea {border: 1px solid var(--kaeli-border);border-radius: 6px;padding: 12px;transition: border-color 0.2s, box-shadow 0.2s;}input:focus, textarea:focus {border-color: var(--kaeli-blue);box-shadow: 0 0 5px rgba(0,122,255,0.3);outline: none;}
#nav-cart { position: relative; }#cart-count {background: var(--kaeli-red);color: white;border-radius: 50%;padding: 2px 6px;font-size: 0.8em;position: absolute;top: -5px;right: -10px;}
#error-toast {transition: opacity 0.4s, transform 0.4s;transform: translateY(20px);}#error-toast.show {opacity: 1;transform: translateY(0);}
.nav-link.active {background: rgba(0,0,0,0.4);color: white;border-radius: 5px;font-weight: bold;}
header {background: linear-gradient(90deg, #0044cc, #0066ff);padding: 10px;color: white;}
.product-card {background: white;border-radius: 8px;padding: 15px;margin: 15px;box-shadow: 0 2px 6px rgba(0,0,0,0.1);transition: box-shadow 0.3s, transform 0.3s;}.product-card:hover {box-shadow: 0 4px 12px rgba(0,0,0,0.2);transform: translateY(-5px);}
input, textarea {border: 1px solid #ccc;border-radius: 6px;padding: 8px;margin: 8px 0;width: 100%;transition: border 0.3s, box-shadow 0.3s;}input:focus, textarea:focus {border: 1px solid #0066ff;box-shadow: 0 0 6px rgba(0,102,255,0.3);outline: none;}
.layout {display: grid;grid-template-columns: 250px 1fr; /* izquierda + derecha */gap: 20px;margin-top: 20px;}
.sidebar {background: var(--kaeli-gray-soft);padding: 15px;border-radius: 8px;box-shadow: 0 2px 6px rgba(0,0,0,0.1);}.sidebar h3 {margin-bottom: 10px;color: var(--kaeli-blue-dark);}.sidebar ul {list-style: none;padding: 0;margin-bottom: 20px;}.sidebar li {margin: 6px 0;}
.products {display: grid;grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));gap: 20px;}
.container {max-width: 1200px;  margin: 0 auto;padding: 0 10px;     }
.layout {display: grid;grid-template-columns: 220px 1fr; /* sidebar m√°s estrecho, productos m√°s amplios */gap: 30px;            /* m√°s espacio entre columnas */align-items: start;   /* sidebar y productos alineados arriba */}
.sidebar {background: var(--kaeli-gray-soft);padding: 20px;border-radius: 8px;box-shadow: 0 2px 6px rgba(0,0,0,0.1);height: fit-content;  /* sidebar se ajusta al contenido */}
.products {display: grid;grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));gap: 25px;justify-items: start; /* tarjetas alineadas a la izquierda */}
/* Sidebar: texto a la izquierda, casilla a la derecha */
.sidebar ul li {
  display: flex;
  justify-content: space-between; /* texto a la izquierda, casilla a la derecha */
  align-items: center;            /* alinea verticalmente */
  padding: 6px 0;
}

.sidebar input[type="checkbox"] {
  width: 18px;   /* tama√±o uniforme */
  height: 18px;  /* cuadrado perfecto */
  margin: 0;     /* quita m√°rgenes raros */
}

</style>
</head>
<body>
<div id="error-toast"></div>
<header>
  <div class="logo" id="nav-logo">üõçÔ∏è Kaeli</div>
  <nav>
    <span class="nav-link" id="nav-comparador">Principal</span>
    <span class="nav-link" id="nav-asistente">Asistente</span>
  </nav>
  <div class="auth-buttons">
    <div id="nav-links-guest">
      <button class="btn btn-primary" id="nav-login">Iniciar Sesi√≥n</button>
      <button class="btn btn-secondary" id="nav-register">Registrarse</button>
    </div>
    <div id="nav-links-user" class="hidden">
      <span id="user-welcome">Hola, ...</span>
      <button class="btn btn-secondary" id="nav-cart">Mi Carrito <span id="cart-count">0</span></button>
      <button class="btn btn-logout" id="nav-logout">Cerrar Sesi√≥n</button>
    </div>
  </div>
</header>

<main class="container">
  <section class="view" id="view-home">
  <!-- Buscador arriba -->
  <div class="search-container">
    <input type="text" id="filter-producto" 
           placeholder="Filtra por producto o tienda (ej: arroz, jumbo)..." 
           autocomplete="off">
  </div>

  <!-- Layout: sidebar + productos -->
  <div class="layout">
    <!-- Sidebar con filtros -->
    <aside class="sidebar">
  <h3>Filtros</h3>
  <ul>
    <li>Arroz <input type="checkbox" value="arroz"></li>
    <li>Fideos <input type="checkbox" value="fideos"></li>
    <li>Leche <input type="checkbox" value="leche"></li>
    <li>Bebida <input type="checkbox" value="bebida"></li>
  </ul>

  <h3>Ordenar por</h3>
  <select id="sort-select">
    <option value="precio-asc">Precio m√°s bajo</option>
    <option value="precio-desc">Precio m√°s alto</option>
    <option value="popularidad">Popularidad</option>
  </select>
</aside>

    <!-- Productos -->
    <div id="results-grid" class="products">
      <!-- Aqu√≠ se renderizan tus product-card din√°micamente -->
    </div>
  </div>
</section>

  <section class="view hidden" id="view-login">
    <form class="auth-container" id="login-form">
      <h2>Iniciar Sesi√≥n</h2>
      <div class="form-group"><label for="login-email">Correo:</label><input type="email" id="login-email" required></div>
      <div class="form-group"><label for="login-pass">Contrase√±a:</label><input type="password" id="login-pass" required></div>
      <button type="submit" class="btn btn-primary form-button">Entrar</button>
    </form>
  </section>

  <section class="view hidden" id="view-register">
    <form class="auth-container" id="register-form">
      <h2>Crear Cuenta</h2>
      <div class="form-group"><label for="reg-nombre">Nombre:</label><input id="reg-nombre" required></div>
      <div class="form-group"><label for="reg-email">Correo:</label><input type="email" id="reg-email" required></div>
      <div class="form-group"><label for="reg-pass">Contrase√±a:</label><input type="password" id="reg-pass" required></div>
      <button type="submit" class="btn btn-primary form-button">Registrarse</button>
    </form>
  </section>

  <section class="view hidden" id="view-assistant">
    <div class="chat-container">
      <div id="chat-box"><div class="chat-msg chat-msg-bot">¬°Hola! Soy Kaeli. Preg√∫ntame sobre el carrito, rese√±as o c√≥mo comparar precios.</div></div>
      <form id="chat-form" class="chat-input"><input type="text" id="chat-input" placeholder="Escribe tu consulta..." autocomplete="off"><button class="btn btn-primary" type="submit">Enviar</button></form>
    </div>
  </section>

  <section class="view hidden" id="view-detail">
    <div id="detail-content"></div>

    <div class="reviews-section">
      <h2 class="section-title">Rese√±as de Usuarios</h2>
      <ul id="review-list" class="review-list"></ul>

      <form id="review-form" class="hidden">
        <h3 style="margin-top:0">Escribe tu propia rese√±a</h3>
        <div class="form-group"><label for="review-comment">Tu comentario:</label><textarea id="review-comment" rows="4" required></textarea></div>
        <input type="hidden" id="review-product-key">
        <button type="submit" class="btn btn-primary form-button">Enviar Rese√±a</button>
      </form>
    </div>
  </section>
</main>

<div class="modal-overlay hidden" id="cart-modal">
  <div class="modal-content">
    <div class="modal-header"><h2>Mi Carrito</h2><span class="modal-close" id="modal-close">&times;</span></div>
    <div class="modal-body">
      <ul id="cart-items-list"></ul>
      <div id="cart-total">Total: $0</div>
    </div>
  </div>
</div>

<script>
/* ---------- Estado global ---------- */
let authToken = null;
let currentUser = null;
let allProducts = [];
const productKeys = ["arroz","fideos","azucar","sal","cafe"];
const EMOJI_MAP_STORE = {"lider":"üîµ","jumbo":"üü¢","santa-isabel":"üî¥"};
const EMOJI_MAP_PRODUCT = {
  "arroz":"üçö",
  "fideos":"üçù",
  "azucar":"üç¨",
  "sal":"üßÇ",
  "cafe":"‚òïÔ∏è",
  "te":"üçµ",
  "aceite":"ü´í",
  "leche":"ü•õ",
  "pan":"üçû",
  "mantequilla":"üßà",
  "queso":"üßÄ",
  "jamon":"ü•ì",
  "pollo":"üçó",
  "carne":"ü•©",
  "pescado":"üêü",
  "huevos":"ü•ö",
  "yogurt":"üç∂",
  "cereal":"ü•£",
  "galletas":"üç™",
  "chocolate":"üç´",
  "helado":"üç¶",
  "jugo":"üßÉ",
  "bebida":"ü•§",
  "agua":"üíß",
  "vino":"üç∑",
  "cerveza":"üç∫",
  "pasta_dental":"ü™•",
  "shampoo":"üß¥",
  "jabon":"üßº",
  "detergente":"üß∫",
  "lavaloza":"üßΩ",
  "papel_higienico":"üßª",
  "servilletas":"üìÑ",
  "pa√±ales":"üë∂",
  "toallas_higienicas":"üå∏",
  "default":"üõí"
};
function getEmoji(productKey) {
  const key = (productKey || "").toLowerCase();

  if (key.startsWith("fideos")) return "üçù";
  if (key.startsWith("arroz")) return "üçö";
  if (key.startsWith("leche")) return "ü•õ";
  if (key.startsWith("bebida")) return "ü•§";

  // Si no calza con ning√∫n prefijo, busca en el mapa
  return EMOJI_MAP_PRODUCT[key] || EMOJI_MAP_PRODUCT.default;
}


const $ = s => document.querySelector(s);

/* ---------- Elementos ---------- */
const views = document.querySelectorAll('.view');
const navLinkComparator = $('#nav-comparador');
const navLinkAssistant = $('#nav-asistente');
const navLinksGuest = $('#nav-links-guest');
const navLinksUser = $('#nav-links-user');
const userWelcome = $('#user-welcome');
const loginForm = $('#login-form');
const registerForm = $('#register-form');
const errorToast = $('#error-toast');
const cartModal = $('#cart-modal');
const cartCount = $('#cart-count');
const cartItemsList = $('#cart-items-list');
const cartTotal = $('#cart-total');
const resultsGrid = $('#results-grid');
const inputFiltro = $('#filter-producto');
const chatForm = $('#chat-form');
const chatInput = $('#chat-input');
const chatBox = $('#chat-box');
const detailContent = $('#detail-content');
const reviewList = $('#review-list');
const reviewForm = $('#review-form');
const reviewComment = $('#review-comment');
const reviewProductKey = $('#review-product-key');

/* ---------- Helpers ---------- */
function showError(msg, success=false){
  errorToast.textContent = msg;
  errorToast.style.background = success ? "var(--kaeli-green)" : "var(--kaeli-red)";
  errorToast.classList.add('show');
  setTimeout(()=>errorToast.classList.remove('show'),3000);
}
function showView(id){
  views.forEach(v=>v.classList.add('hidden'));
  $('#' + id).classList.remove('hidden');
  navLinkComparator.classList.toggle('active', id==='view-home');
  navLinkAssistant.classList.toggle('active', id==='view-assistant');
  if(id==='view-home' && allProducts.length===0) loadAllProducts();
}

/* ---------- API helper ---------- */
async function callApi(endpoint, method='GET', body=null, needsAuth=false){
  const headers = {'Content-Type':'application/json'};
  const options = {method, headers};
  if(body) options.body = JSON.stringify(body);
  if(needsAuth){
    if(!authToken){
      showError("Necesitas iniciar sesi√≥n para esta acci√≥n.");
      showView('view-login');
      return null;
    }
    headers['Authorization'] = `Bearer ${authToken}`;
  }
  try{
    const res = await fetch(endpoint, options);
    const data = await res.json();

    if(!res.ok){
      // üëá Manejo especial para token expirado
      if(res.status === 401){
        showError("Tu sesi√≥n ha expirado. Inicia sesi√≥n nuevamente.");
        updateUIAfterLogout();   // limpia token y UI
        showView('view-login');  // redirige al login
      } else {
        showError(`Error: ${data.error || res.statusText}`);
      }
      return null;
    }

    return data;
  }catch(err){
    showError("Error de conexi√≥n: " + err.message);
    return null;
  }
}


/* ---------- Auth ---------- */
registerForm.onsubmit = async e => {
  e.preventDefault();
  const payload = {
    nombre: $('#reg-nombre').value,
    correo: $('#reg-email').value,
    password: $('#reg-pass').value
  };
  const data = await callApi('/api/register','POST',payload);
  if(data){ showError("Registro exitoso! Inicia sesi√≥n.", true); showView('view-login'); }
};
loginForm.onsubmit = async e => {
  e.preventDefault();
  const payload = { correo: $('#login-email').value, password: $('#login-pass').value };
  const data = await callApi('/api/login','POST',payload);
  if(data && data.access_token){
    authToken = data.access_token;
    currentUser = data.usuario;
    localStorage.setItem('kaeliToken', authToken);
    localStorage.setItem('kaeliUser', JSON.stringify(currentUser));
    updateUIAfterLogin();
  }
};
function updateUIAfterLogin(){
  navLinksGuest.classList.add('hidden');
  navLinksUser.classList.remove('hidden');
  userWelcome.textContent = `Hola, ${currentUser.nombre}`;
  loadUserCart();
  showView('view-home');
}
function updateUIAfterLogout(){
  navLinksGuest.classList.remove('hidden');
  navLinksUser.classList.add('hidden');
  localStorage.removeItem('kaeliToken');
  localStorage.removeItem('kaeliUser');
  authToken = null; currentUser = null;
  cartCount.textContent = "0";
  showView('view-home');
}

/* ---------- Navigation ---------- */
$('#nav-logo').onclick = ()=>showView('view-home');
$('#nav-comparador').onclick = ()=>showView('view-home');
$('#nav-asistente').onclick = ()=>showView('view-assistant');
$('#nav-login').onclick = ()=>showView('view-login');
$('#nav-register').onclick = ()=>showView('view-register');
$('#nav-logout').onclick = ()=>updateUIAfterLogout();
$('#nav-cart').onclick = async ()=>{ await loadUserCart(); cartModal.classList.remove('hidden'); };
$('#modal-close').onclick = ()=>cartModal.classList.add('hidden');
cartModal.onclick = e => { if(e.target===cartModal) cartModal.classList.add('hidden'); };

/* ---------- Products & rendering ---------- */
async function loadAllProducts(){
  resultsGrid.innerHTML = "<h3>Cargando productos...</h3>";
  const data = await callApi("/api/productos");
  if(!data) return;

  // Convertir diccionario en array de productos
  allProducts = Object.entries(data).map(([key, producto]) => {
    const precios = Object.values(producto.precios);
    const precioMin = Math.min(...precios);
    return {
      product_key: key,
      producto: producto.nombre_generico,
      precio: precioMin,
      supermercado: producto.supermercado || '' // si tu API lo trae
    };
  });

  renderProducts(allProducts);
}

function renderProducts(products){
  resultsGrid.innerHTML = "";
  if(products.length===0){ 
    resultsGrid.innerHTML = "<p>No se encontraron productos.</p>"; 
    return; 
  }
  products.forEach(p => {
    const card = renderProductCard(p);
    resultsGrid.appendChild(card);
  });
}

function renderProductCard(item){
  const card = document.createElement('div');
  card.className = "product-card";
  const storeClass = (item.supermercado||'').toLowerCase().replace('√≠','i').replace(/\s+/g,'-');
  const foodEmoji = getEmoji(item.product_key);
  card.dataset.nombre = (item.producto || item.product_key || '').toLowerCase();
  card.dataset.tienda = (item.supermercado || '').toLowerCase();
  card.dataset.key = item.product_key;
  card.innerHTML = `
    <div class="product-card-store ${storeClass}">${EMOJI_MAP_STORE[storeClass] || 'üè™'} ${item.supermercado || ''}</div>
    <div class="product-card-body" data-key="${item.product_key}" data-name="${item.producto || item.product_key}">
      <p class="product-card-name ${storeClass}">${foodEmoji} ${item.producto || item.product_key}</p>
      <div class="product-card-price">$${item.precio || 0}</div>
    </div>
  `;
  return card;
}

/* ---------- Interacciones ---------- */
// Click en producto ‚Üí detalle
resultsGrid.onclick = function(e){
  const body = e.target.closest('.product-card-body');
  if(body){ 
    const productKey = body.dataset.key; 
    handleShowDetail(productKey); 
  }
};

// Buscador por texto
inputFiltro.oninput = function(){
  const term = inputFiltro.value.toLowerCase();
  document.querySelectorAll('.product-card').forEach(card=>{
    const nombre = card.dataset.nombre||'';
    const tienda = card.dataset.tienda||'';
    card.style.display = (nombre.includes(term) || tienda.includes(term)) ? 'block' : 'none';
  });
};

/* ---------- Sidebar filtros ---------- */
// Escuchar cambios en los checkboxes
document.querySelectorAll('.sidebar input[type="checkbox"]').forEach(cb => {
  cb.addEventListener('change', aplicarFiltros);
});

// Escuchar cambios en el select de orden
document.getElementById('sort-select').addEventListener('change', aplicarFiltros);

function aplicarFiltros() {
  // 1. Obtener filtros activos
  const activos = Array.from(document.querySelectorAll('.sidebar input[type="checkbox"]:checked'))
                       .map(cb => cb.value.toLowerCase());

  // 2. Clonar productos originales
  let productosFiltrados = [...allProducts];

  // 3. Filtrar por product_key
  if (activos.length > 0) {
  productosFiltrados = productosFiltrados.filter(p =>
    activos.some(f => (p.product_key || '').toLowerCase().startsWith(f))
  );
}

  // 4. Ordenar seg√∫n select
  const orden = document.getElementById('sort-select').value;
  if (orden === 'precio-asc') {
    productosFiltrados.sort((a, b) => a.precio - b.precio);
  } else if (orden === 'precio-desc') {
    productosFiltrados.sort((a, b) => b.precio - a.precio);
  }

  // 5. Renderizar
  renderProducts(productosFiltrados);
}

/* ---------- Detail + rese√±as ---------- */
async function handleShowDetail(productKey){
  showView('view-detail');
  detailContent.innerHTML = "<h3>Cargando detalle...</h3>";
  reviewList.innerHTML = "";
  const data = await callApi(`/api/producto/${productKey}`);
  if(data) renderProductDetail(data);
}
function renderProductDetail(data){
  // data: { producto_key, nombre_generico, precios: [], rese√±as: [] }
  const foodEmoji = EMOJI_MAP_PRODUCT[data.producto_key] || EMOJI_MAP_PRODUCT.default;
  let pricesHTML = '<ul class="price-list">';
  (data.precios || []).forEach(item=>{
    pricesHTML += `<li class="price-list-item">
      <div><span class="price-list-item-store">${EMOJI_MAP_STORE[(item.supermercado||'').toLowerCase().replace('√≠','i').replace(' ','-')]||'üè™'} ${item.supermercado||''}</span><div class="price-list-item-price">$${item.precio||0}</div></div>
      <button class="btn btn-primary price-list-item-button btn-add-cart-detail" data-nombre="${item.producto||data.nombre_generico}" data-precio="${item.precio||0}" data-supermercado="${item.supermercado||''}">Agregar</button>
    </li>`;
  });
  pricesHTML += '</ul>';
  detailContent.innerHTML = `
    <button id="btn-back-home" class="btn btn-secondary" style="margin-bottom:20px">&larr; Volver a Principal</button>
    <div class="detail-layout">
      <div id="detail-image"><span style="font-size:5em">${foodEmoji}</span></div>
      <div id="detail-info"><h1>${data.nombre_generico||'Producto'}</h1>${pricesHTML}</div>
    </div>
  `;
  // rese√±as
  reviewList.innerHTML = "";
  if(!data.rese√±as || data.rese√±as.length===0){
    reviewList.innerHTML = "<p>A√∫n no hay rese√±as para este producto.</p>";
  } else {
    data.rese√±as.forEach(review=>{
  const li = document.createElement('li'); 
  li.className = 'review-item';
  li.innerHTML = `
    <strong>${review.nombre_usuario}</strong>
    <p>${review.comentario}</p>
    <div class="review-votes">
      üëç ${review.votos_utiles} 
      <button class="btn-vote" data-id="${review.id_resena}">
        ${review.ya_vote ? "Quitar voto" : "Votar √∫til"}
      </button>
    </div>
  `;
  reviewList.appendChild(li);
});
  }
  // show form if logged
  if(authToken){ reviewForm.classList.remove('hidden'); reviewProductKey.value = data.producto_key; }
  else { reviewForm.classList.add('hidden'); }
  $('#btn-back-home').onclick = ()=>showView('view-home');
}

//* submit rese√±a */
reviewForm.onsubmit = async e => {
  e.preventDefault();
  const comment = reviewComment.value.trim();
  const productKey = reviewProductKey.value;
  if(!comment) return;
  const payload = { producto_key: productKey, comentario: comment };
  const data = await callApi('/api/resenas','POST',payload,true);
  if(data){ 
    showError("¬°Rese√±a publicada!", true); 
    reviewComment.value=''; 
    handleShowDetail(productKey); 
  }
};

/* listener para votos */
reviewList.addEventListener('click', async e => {
  if(e.target.classList.contains('btn-vote')){
    const idResena = e.target.dataset.id;
    const data = await callApi(`/api/resenas/vote/${idResena}`, 'POST', {}, true);
    if(data){
      showError(`Voto ${data.accion}`, true);
      handleShowDetail(reviewProductKey.value); // refresca el detalle
    }
  }
});

/* ---------- Carrito (b√°sico) ---------- */
detailContent.onclick = function(e){
  if(e.target.classList.contains('btn-add-cart-detail')){
    const producto = { nombre: e.target.dataset.nombre, precio: parseInt(e.target.dataset.precio||0,10), supermercado: e.target.dataset.supermercado };
    handleAddToCart(producto);
  }
};
async function handleAddToCart(producto){
  const data = await callApi('/api/carrito/agregar','POST',producto,true);
  if(data){ updateCartUI(data); showError(`${producto.nombre} agregado al carrito!`,true); }
}
async function loadUserCart(){
  if(!authToken) return;
  const data = await callApi('/api/carrito','GET',null,true);
  if(data) updateCartUI(data);
}
function updateCartUI(cartData){
  cartItemsList.innerHTML = "";
  if(!cartData || !cartData.items || cartData.items.length===0){ cartItemsList.innerHTML = "<li>Tu carrito est√° vac√≠o.</li>"; }
  else {
    cartData.items.forEach(item=>{
      const li = document.createElement('li');
      li.dataset.nombre = item.nombre; li.dataset.precio = item.precio; li.dataset.supermercado = item.supermercado;
      li.innerHTML = `<span>${item.nombre} <small>(${item.supermercado})</small></span>
      <div class="cart-controls"><span class="cart-remove-item" title="Eliminar">üóëÔ∏è</span>
      <div class="cart-quantity"><button class="btn-cart-subtract">-</button><span class="cart-quantity-amount">${item.cantidad}</span><button class="btn-cart-add">+</button></div></div>`;
      cartItemsList.appendChild(li);
    });
  }
  cartTotal.textContent = `Total: $${(cartData ? cartData.total : 0).toLocaleString("es-CL")}`;
  cartCount.textContent = cartData ? cartData.cantidad_items : 0;
}
cartItemsList.onclick = async function(e){
  const target = e.target.closest('button,span');
  if(!target) return;
  const li = target.closest('li'); if(!li) return;
  const productData = { nombre: li.dataset.nombre, precio: parseInt(li.dataset.precio||0,10), supermercado: li.dataset.supermercado };
  let data=null;
  if(target.classList.contains('btn-cart-add')) data = await callApi('/api/carrito/agregar','POST',productData,true);
  else if(target.classList.contains('btn-cart-subtract')) data = await callApi('/api/carrito/restar','POST',productData,true);
  else if(target.classList.contains('cart-remove-item')) data = await callApi('/api/carrito/eliminar','POST',productData,true);
  if(data) updateCartUI(data);
};

/* ---------- Chat ---------- */
chatForm.onsubmit = async e => {
  e.preventDefault();
  const consulta = chatInput.value.trim(); if(!consulta) return;
  appendChatMessage(consulta,'user'); chatInput.value='';
  const data = await callApi('/api/asistente/consulta','POST',{consulta});
  if(data) appendChatMessage(data.respuesta,'bot');
};
function appendChatMessage(message,sender){
  const d = document.createElement('div'); d.className = `chat-msg chat-msg-${sender}`; d.textContent = message; chatBox.appendChild(d); chatBox.scrollTop = chatBox.scrollHeight;
}

/* ---------- Init ---------- */
function initApp(){
  const token = localStorage.getItem('kaeliToken');
  if(token){ authToken = token; currentUser = JSON.parse(localStorage.getItem('kaeliUser')); updateUIAfterLogin(); }
  else showView('view-home');
}
initApp();
</script>
</body>
</html>